name: Gerar Bandeiras

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cozinhar:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # --- ESTRATÉGIA NOVA: CLONAR DIRETO ---
      - name: Baixar o Cérebro do Robô (Git Clone)
        run: |
          # Limpa tudo antes para garantir
          rm -rf FlagsMashupBot flags *.py countries colors requirements*
          
          # Clona o repositório original numa pasta temporária
          git clone https://github.com/antooro/FlagsMashupBot.git temp_bot
          
          # Move o conteúdo para a raiz (onde o cook.py consegue ver)
          cp -r temp_bot/* .
          
          # Apaga a pasta temporária
          rm -rf temp_bot
          
          # --- TESTE DE SEGURANÇA ---
          # Vai mostrar no log se os arquivos estão lá mesmo
          echo "Verificando arquivos essenciais:"
          ls -l countries flags/BR.svg names.py formatsvg.py || echo "ALERTA: Algo falta!"

      - name: Instalar Dependências do Linux
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev pkg-config python3-dev

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar Bibliotecas
        run: |
          pip install pycairo
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # Recriamos o cook.py aqui para garantir que ele é compatível
      # (Colei o código do seu cook.py aqui dentro do YAML para facilitar)
      - name: Criar o Cozinheiro (Cook)
        run: |
          cat <<EOF > cook.py
          import os
          import random
          import json
          import shutil
          try:
              import names
              import formatsvg
          except ImportError as e:
              print(f"ERRO CRITICO: Faltam arquivos do bot! {e}")
              exit(1)

          QUANTIDADE = 50 
          PASTA_SITE = "img_bandeiras"

          if os.path.exists(PASTA_SITE): shutil.rmtree(PASTA_SITE)
          os.makedirs(PASTA_SITE)

          # Verifica se o arquivo countries existe
          if not os.path.exists('countries'):
              print("ERRO: Arquivo 'countries' não encontrado!")
              exit(1)

          with open('countries', 'r') as f:
              # Filtra linhas vazias
              linhas = [l.strip() for l in f.read().splitlines() if l.strip()]

          cardapio = []
          print(f"Gerando {QUANTIDADE} bandeiras...")

          for i in range(QUANTIDADE):
              try:
                  linha_a = random.choice(linhas)
                  linha_b = random.choice(linhas)
                  
                  # Lógica para separar ID e Nome
                  def separar(linha):
                      if ';' in linha: return linha.split(';')
                      return linha.split(' ', 1)

                  pais_a = separar(linha_a)
                  pais_b = separar(linha_b)
                  
                  # Garante que não são iguais
                  while pais_a[0] == pais_b[0]:
                      pais_b = separar(random.choice(linhas))

                  nome_misturado = names.mix(pais_a[1], pais_b[1])
                  
                  # O formatsvg precisa dos caminhos assim:
                  bandeira_a = f"flags/{pais_a[0]}.svg"
                  bandeira_b = f"flags/{pais_b[0]}.svg"
                  
                  # Executa a mistura
                  formatsvg.mix(bandeira_a, bandeira_b)
                  
                  nome_final = f"mashup_{i}.png"
                  destino = os.path.join(PASTA_SITE, nome_final)
                  
                  if os.path.exists("output.png"):
                      shutil.move("output.png", destino)
                      cardapio.append({
                          "arquivo": nome_final,
                          "nome": nome_misturado
                      })
                      print(f"Sucesso: {nome_misturado}")
                  
              except Exception as e:
                  print(f"Erro na {i}: {e}")

          with open(os.path.join(PASTA_SITE, "menu.json"), "w") as f:
              json.dump(cardapio, f)
          EOF

      - name: Rodar o Cook
        run: python cook.py

      - name: Salvar Imagens
        run: |
          git config --global user.name 'Bot'
          git config --global user.email 'bot@noreply.github.com'
          git add img_bandeiras
          git commit -m "Novas bandeiras" || echo "Nada novo"
          git push
